<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Košík – Lumièra Noir</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Inter:wght@300;400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="galaxy"></div>
<div class="city"></div>

<!-- NAVBAR -->
<nav>
  <div class="nav-inner">
    <div class="logo">LUMIÈRA NOIR</div>
    <div class="menu">
      <a href="index.html">Domov</a>
      <a href="collection.html">Kolekcia</a>
      <a href="vision.html">Vízia</a>
      <a href="private-order.html">Vlastná objednávka</a>
      <a href="about.html">O nás</a>
      <a href="cart.html" class="active">Košík</a>
    </div>
  </div>
</nav>

<section class="section" style="padding:60px 8%;">
  <h2>Váš výber</h2>

  <table class="cart-table" id="cartTable">
    <thead>
      <tr>
        <th>Názov</th>
        <th>Variant</th>
        <th>Množstvo</th>
        <th>Cena</th>
        <th>Odstrániť</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="3"><strong>Spolu</strong></td>
        <td colspan="2" id="cartTotal"></td>
      </tr>
    </tfoot>
  </table>

  <button id="openCheckout" style="margin-top:24px;">Dokončiť a odoslať objednávku</button>

  <!-- CHECKOUT MODAL -->
  <div class="modal" id="checkoutModal">
    <div class="modal-box">
      <div class="close" onclick="closeCheckout()">✕</div>
      <h2>Potvrdenie objednávky</h2>
      <div id="checkoutCartPreview" style="margin-bottom:24px;"></div>

      <!-- STEP 1 – Kontaktné údaje -->
      <div class="checkout-step step-1 active">
        <h3>1. Kontaktné údaje</h3>
        <input name="firstName" placeholder="Meno" required>
        <input name="lastName" placeholder="Priezvisko" required>
        <input name="email" placeholder="Email" type="email" required>
        <input name="phone" placeholder="Telefón" type="tel" required>
        <button onclick="nextStep()">Ďalej</button>
      </div>

      <!-- STEP 2 – Doručenie -->
      <div class="checkout-step step-2">
        <h3>2. Doručenie</h3>
        <input name="street" placeholder="Ulica" required>
        <input name="city" placeholder="Mesto" required>
        <input name="zip" placeholder="PSČ" required>
        <select name="delivery">
          <option>Osobný odber</option>
          <option>Rozvoz BA + TT (+10€)</option>
        </select>
        <button onclick="prevStep()">Späť</button>
        <button onclick="nextStep()">Ďalej</button>
      </div>

      <!-- STEP 3 – Potvrdenie -->
      <div class="checkout-step step-3">
        <h3>3. Potvrdenie objednávky</h3>
        <label style="display:block;font-size:12px;opacity:0.7;margin-top:10px;">
          <input type="checkbox" id="gdprCheckout" required> Súhlasím so spracovaním osobných údajov
        </label>
        <button onclick="prevStep()">Späť</button>
        <button onclick="submitCheckout()">Odoslať objednávku</button>
        <div id="checkoutMessage" style="opacity:0.7;margin-top:10px;"></div>
      </div>

    </div>
  </div>

</section>

<footer style="padding:50px 0; text-align:center; font-size:.75rem; opacity:.6;">
  © 2026 Lumièra Noir · <span id="visits"></span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
<script src="js/app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const cartTableBody = document.querySelector("#cartTable tbody");
  const cartTotalElem = document.getElementById("cartTotal");
  const checkoutModal = document.getElementById("checkoutModal");
  const checkoutCartPreview = document.getElementById("checkoutCartPreview");
  let currentStep = 1;
  const steps = document.querySelectorAll(".checkout-step");

  function getCart() {
    return JSON.parse(localStorage.getItem("cart") || "[]");
  }

  function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  function renderCart() {
    const cart = getCart();
    cartTableBody.innerHTML = "";
    let total = 0;
    cart.forEach((item, idx) => {
      const row = document.createElement("tr");
      const subtotal = item.price * item.qty;
      total += subtotal;
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.variant}</td>
        <td>${item.qty}</td>
        <td>${subtotal} €</td>
        <td><button data-idx="${idx}" class="removeBtn">X</button></td>
      `;
      cartTableBody.appendChild(row);
    });
    cartTotalElem.innerText = total + " €";

    document.querySelectorAll(".removeBtn").forEach(btn => {
      btn.addEventListener("click", e => {
        const idx = e.target.dataset.idx;
        const cart = getCart();
        cart.splice(idx, 1);
        saveCart(cart);
        renderCart();
      });
    });
  }

  renderCart();

  // CHECKOUT MODAL
  document.getElementById("openCheckout").addEventListener("click", () => {
    const cart = getCart();
    if(cart.length === 0) {
      alert("Váš košík je prázdny.");
      return;
    }
    checkoutModal.style.display = "flex";
    checkoutCartPreview.innerHTML = cart.map(i =>
      `<div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <span>${i.name} (${i.variant}) x${i.qty}</span>
        <span>${i.price*i.qty} €</span>
      </div>`).join("");
  });

  window.closeCheckout = function() { checkoutModal.style.display = "none"; }

  window.nextStep = function() {
    if(currentStep < steps.length) {
      steps[currentStep-1].classList.remove("active");
      currentStep++;
      steps[currentStep-1].classList.add("active");
    }
  }

  window.prevStep = function() {
    if(currentStep > 1) {
      steps[currentStep-1].classList.remove("active");
      currentStep--;
      steps[currentStep-1].classList.add("active");
    }
  }

  window.submitCheckout = function() {
    const gdpr = document.getElementById("gdprCheckout");
    if(!gdpr.checked){
      alert("Musíte súhlasiť so spracovaním osobných údajov.");
      return;
    }
    const cart = getCart();
    if(cart.length === 0){
      alert("Košík je prázdny.");
      return;
    }

    const formData = {
      firstName: steps[0].querySelector("input[name='firstName']").value,
      lastName: steps[0].querySelector("input[name='lastName']").value,
      email: steps[0].querySelector("input[name='email']").value,
      phone: steps[0].querySelector("input[name='phone']").value,
      street: steps[1].querySelector("input[name='street']").value,
      city: steps[1].querySelector("input[name='city']").value,
      zip: steps[1].querySelector("input[name='zip']").value,
      delivery: steps[1].querySelector("select[name='delivery']").value,
      cart: cart
    };

    emailjs.send('service_skuvlfb','template_17jkem8',formData,'uBmaCJ5QxxC0LOY1W')
      .then(() => {
        document.getElementById("checkoutMessage").innerText = "Objednávka úspešne odoslaná!";
        localStorage.removeItem("cart");
        renderCart();
        closeCheckout();
      }).catch(err => {
        console.error(err);
        document.getElementById("checkoutMessage").innerText = "Chyba pri odosielaní objednávky, skúste neskôr.";
      });
  }
});
</script>

</body>
</html>
